<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Army Markdown Editor</title>

    <style>
      .box {
        height: 80%;
      }

      html,
      body {
        margin: 0px;
        height: 100%;
      }

      form {
        height: 100%;
      }

      .button {
        font-size: 26px;
      }

      .CodeMirror {
        height: 90%;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"
    />
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  </head>

  <body>
    <div class="box">
      <textarea name="memo_text" id="editor">{{memo_text}}</textarea>
      <button id="start-bg-job">Create Memo PDF</button>
      <button id="start-spellcheck">Check Spelling and Grammar</button>
    </div>

    <form method="POST" id="download">
      <!-- Hidden form for submitting -->
      <input type="hidden" name="param1" value="value1" />
    </form>

    <script>
      let editor = new SimpleMDE({
        autofocus: true,
        tabSize: 4,
        toolbar: false,
      });

      function button_press(endpoint, polling_function) {
        $.ajax({
          type: "POST",
          url: endpoint,
          data: { memo_text: editor.value() },
          success: function (data, status, request) {
            status_url = request.getResponseHeader("Location");
            polling_function(status_url);
          },
          error: function () {
            alert("Unexpected error");
          },
        });
      }

      function generate_memo() {
        button_press("/process", update_progress);
      }

      function start_spellcheck() {
        button_press("/spellcheck", poll_spellcheck);
      }

      function poll_spellcheck(status_url) {
        $.get(status_url, function (data) {
          if (data["state"] == "SUCCESS") {
            editor.value(data["text"]);
          } else {
            setTimeout(function () {
              poll_spellcheck(status_url);
            }, 1000);
          }
        });
      }

      let count = 0;
      function update_progress(status_url) {
        // send GET request to status URL
        $.get(status_url, function (data) {
          if (data["state"] == "SUCCESS") {
            return get_pdf(data["pdf_file"]);
          } else {
            let rerun_freq = 2000;
            count += 1;
            // rerun in 2 seconds
            if (count < 50) {
              editor.value(
                "Waiting for your memo pdf to be generated! Please be patient! It's only been " +
                  count * 2 +
                  " seconds."
              );
              setTimeout(function () {
                update_progress(status_url);
              }, rerun_freq);
            }
          }
        });
      }

      function get_pdf(pdf_name) {
        $("#download").attr("action", "results/" + pdf_name);
        $("#download").submit();
      }

      $(function () {
        $("#start-bg-job").click(generate_memo);
      });

      $(function () {
        $("#start-spellcheck").click(start_spellcheck);
      });
    </script>
  </body>
</html>
