name: Deploy to Production

# Manual trigger only - Watchtower handles automatic image updates
# Use this workflow when:
#   - You changed docker-compose-production.yaml
#   - You need immediate deployment (don't want to wait 5 min for Watchtower)
#   - You need to debug deployment issues
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          set -e  # Exit on any error

          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“… $(date)"

          # Change to project directory
          cd /root/armymarkdown

          # Check .env file exists
          if [ ! -f ".env" ]; then
            echo "âŒ Error: .env file not found!"
            echo "   Please create /root/armymarkdown/.env with required secrets"
            exit 1
          fi

          # Update repository
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          # Pull latest images
          echo "ğŸ“¦ Pulling latest Docker images..."
          docker compose -f infrastructure/compose/docker-compose-production.yaml pull

          # Restart services
          echo "ğŸ”„ Restarting services..."
          docker compose -f infrastructure/compose/docker-compose-production.yaml up -d --remove-orphans

          # Wait for health checks
          echo "â³ Waiting for services to be healthy..."
          sleep 15

          # Check health
          for i in {1..6}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… App is healthy!"
              break
            fi
            echo "   Waiting for app to be ready... (attempt $i/6)"
            sleep 10
          done

          # Verify deployment
          echo ""
          echo "ğŸ“Š Service Status:"
          docker compose -f infrastructure/compose/docker-compose-production.yaml ps

          # Show health check result
          echo ""
          echo "ğŸ¥ Health Check:"
          curl -s http://localhost:8000/health | python3 -m json.tool || echo "Health check unavailable"

          # Clean up old images
          echo ""
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo ""
          echo "âœ¨ Deployment complete!"
          echo "ğŸŒ Site: https://armymemomaker.com"
